name: RPi Image Modifier
description: Raspberry Pi OS Image Modifier

inputs:
  base-image-url:
    description: 'Base Raspberry Pi OS image URL'
    required: true
  image-path:
    description: 'Where to locate the modifier image'
    required: false
    default: ''
  files:
    description: 'Files to copy to image'
    required: false
    default: ''
  script-path:
    description: 'Path of script to run to modify image'
    required: false
    default: ''
  run:
    description: 'Bash script containers to run to modify image'
    required: false
    default: ''
  image-maxsize:
    description: 'That maximum size of the modified image'
    required: false
    default: '12G'

outputs:
  image-path:
    description: 'Path of modified Raspberry Pi OS image'
    #value: ${{ steps.random-number-generator.outputs.random-number }}
    value: TODO

runs:
  using: "composite"
  steps:
    -
      name: Make sure environment is supported
      shell: bash
      env:
        ARG_SCRIPT_PATH: ${{ inputs.script-path }}
        ARG_RUN: ${{ inputs.run }}
      run: |
        if [ "${RUNNER_OS}" != "Linux" ]; then
          echo "${RUNNER_OS} not supported"
          exit 1
        fi

        if [ -z "${ARG_SCRIPT_PATH}" -a -z "${ARG_RUN}" ]; then
          echo 'You must specify either a script-path or run input'
          exit 1
        fi
    -
      name: Setup Python
      uses: actions/setup-python@v4
      id: setup-python
      with:
        python-version: '3.12'
        update-environment: false
    -
      name: Setup requirements
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          systemd-container
    -
      name: Download Raspberry Pi OS image
      shell: bash
      id: download-image
      env:
        ARG_BASE_IMAGE_URL: ${{ inputs.base-image-url }}
      run: |
        TEMPDIR="$(mktemp -d)"
        cd "${TEMPDIR}"

        echo "Downloading ${ARG_BASE_IMAGE_URL}..."
        wget -q --content-disposition "${ARG_BASE_IMAGE_URL}"

        DOWNLOADED_IMAGE_PATH="$(ls -1)"
        MIMETYPE="$(file -b --mime-type ${DOWNLOADED_IMAGE_PATH})"

        case "${MIMETYPE}" in
          application/x-xz) xz -d "${DOWNLOADED_IMAGE_PATH}" ;;
          application/gzip) gzip -d "${DOWNLOADED_IMAGE_PATH}" ;;
          application/x-bzip2) bzip2 -d "${DOWNLOADED_IMAGE_PATH}" ;;
          application/x-lzma) lzma -d "${DOWNLOADED_IMAGE_PATH}" ;;
          application/zip)
            unzip "${DOWNLOADED_IMAGE_PATH}"
            rm "${DOWNLOADED_IMAGE_PATH}"
            ;;
        esac

        echo "downloaded-image-workdir=${TEMPDIR}" >> "${GITHUB_OUTPUT}"
    -
      name: Modify Raspberry Pi OS Image
      shell: bash
      env:
        ARG_DOWNLOADED_IMAGE_WORKDIR: ${{ steps.download-image.outputs.working-dir }}
        ARG_IMAGE_PATH: ${{ inputs.image-path }}
        ARG_FILES: ${{ inputs.files }}
        ARG_SCRIPT_PATH: ${{ inputs.script-path }}
        ARG_RUN: ${{ inputs.run }}
        ARG_IMAGE_MAXSIZE: ${{ inputs.image-maxsize }}
      run: ${{ steps.setup-python.outputs.python-path }} "${GITHUB_ACTION_PATH}/action.py"
    -
      name: Debug
      uses: mxschmitt/action-tmate@v3
      # name: Run image modifier script
      # shell: bash
      # env:
      #   ARG_BASE_IMAGE_URL: ${{ inputs.base-image-url }}
      #   ARG_IMAGE_PATH: ${{ inputs.image-path }}
      #   ARG_FILES: ${{ inputs.files }}
      #   ARG_SCRIPT_PATH: ${{ inputs.script-path }}
      #   ARG_RUN: ${{ inputs.run }}
      # run: |
      #   env
